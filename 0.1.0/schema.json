{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "$id": "https://github.com/EdgelessPE/nep-spec/master/0.1.0/schema.json",
  "title": "NEP Config",
  "description": "Schema for Next-generation Edgeless Package config in toml",
  "type": "object",
  "x-taplo-info": {
    "authors": ["Cno (https://github.com/Cnotech)"],
    "version": "0.1.0",
    "patterns": ["^package.toml$"]
  },
  "properties": {
    "package": {
      "description": "Basic informanion of this package",
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[^_]+$"
        },
        "type": {
          "type": "string",
          "enum": ["Software", "Driver", "Manifest", "Dependency", "Theme"]
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+.\\d+.\\d+.\\d+$"
        },
        "authors": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^\\w+(\\s<@\\w+>)?$"
          }
        },
        "compat": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^([><]=?)?\\d+.\\d+.\\d+$"
          }
        },
        "tested": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^\\d+.\\d+.\\d+$"
          }
        }
      },
      "required": ["name", "type", "version", "authors", "tested"]
    },
    "setup_flow": {
      "type": "object",
      "patternProperties": {
        "^\\w*": {
          "$ref": "#/definitions/generalSteps"
        }
      }
    }
  },
  "required": ["package", "setup_flow"],
  "definitions": {
    "generalSteps": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[\\sA-Za-z0-9]+$"
        },
        "if":{
          "type":"string"
        },
        "else":{
          "type":"string"
        },
        "elif":{
          "type":"string"
        },
        "throw":{
          "type":"string"
        }
      },
      "required": ["name"],
      "oneOf":[
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Group"]
            }
          },
          "required":["type"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["LogicAnd","LogicOr"]
            },
            "exp":{
              "type":"array",
              "items": {
                "type":"string"
              }
            }
          },
          "required":["type","exp"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Modify"]
            },
            "key":{
              "type":"string",
              "pattern": "^(?:env|uc).\\w+$"
            },
            "value":{
              "type":["string","integer","boolean"]
            }
          },
          "required":["type","key","value"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Wait"]
            },
            "timeout":{
              "type":"integer"
            }
          },
          "required":["type","timeout"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Link"]
            },
            "source_file":{
              "type":"string"
            },
            "target_name":{
              "type":"string"
            },
            "target_args":{
              "type":"string"
            },
            "target_icon":{
              "type":"string"
            },
            "location_default":{
              "type":"string",
              "enum": ["Desktop", "Taskbar", "StartMenu"]
            }
          },
          "required":["type","source_file","target_name"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["File"]
            }
          },
          "required":["type"],
          "oneOf":[
            {
              "properties": {
                "operation":{
                  "type":"string",
                  "enum": ["Copy","Move"]
                },
                "source":{
                  "type":"string"
                },
                "target":{
                  "type":"string"
                },
                "overwrite":{
                  "type":"boolean"
                }
              },
              "required":["operation","source","target"]
            },
            {
              "properties": {
                "operation":{
                  "type":"string",
                  "enum": ["Rename"]
                },
                "source":{
                  "type":"string"
                },
                "target":{
                  "type":"string"
                }
              },
              "required":["operation","source","target"]
            },
            {
              "properties": {
                "operation":{
                  "type":"string",
                  "enum": ["Delete"]
                },
                "source":{
                  "type":"string"
                },
                "force":{
                  "type":"boolean"
                }
              },
              "required":["operation","source"]
            },
            {
              "properties": {
                "operation":{
                  "type":"string",
                  "enum": ["New"]
                },
                "target":{
                  "type":"string"
                },
                "overwrite":{
                  "type":"boolean"
                }
              },
              "required":["operation","target"]
            }
          ]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Script"]
            },
            "path":{
              "type":"string"
            },
            "args":{
              "type":"string"
            },
            "use":{
              "type":"array",
              "items": {
                "type":"string",
                "oneOf":[
                  {
                    "enum": ["ExitCode","Feedback","SystemDrive","EdgelessDrive","DefaultLocation","Desktop","Aria2cPath","EdgelessVersion","BootPolicy"]
                  },
                  {
                    "pattern": "^(?:env|uc).\\w+$"
                  }
                ]
              }
            },
            "pwd":{
              "type":"string"
            },
            "hide":{
              "type":"boolean"
            },
            "wait":{
              "type":"boolean"
            },
            "fix":{
              "type":"array",
              "items": {
                "type":"string"
              }
            }
          },
          "required":["type","path"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Execute"]
            },
            "command":{
              "type":"string"
            },
            "shell":{
              "type":"string",
              "enum": ["cmd","pecmd"]
            },
            "pwd":{
              "type":"string"
            },
            "hide":{
              "type":"boolean"
            },
            "wait":{
              "type":"boolean"
            }
          },
          "required":["type","command","shell"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Kill"]
            },
            "target":{
              "type":"string"
            }
          },
          "required":["type","target"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Path"]
            },
            "record":{
              "type":"string"
            },
            "operation":{
              "type":"string",
              "enum": ["Add","Remove"]
            }
          },
          "required":["type","record","operation"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Log"]
            },
            "level":{
              "type":"string",
              "enum": ["Info","Warning","Error"]
            },
            "msg":{
              "type":"string"
            }
          },
          "required":["type","level","msg"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Toast"]
            },
            "title":{
              "type":"string"
            },
            "content":{
              "type":"string"
            }
          },
          "required":["type","title","content"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Dialog"]
            },
            "title":{
              "type":"string"
            },
            "content":{
              "type":"string"
            },
            "options":{
              "type":"array",
              "items": {
                "type":"string"
              }
            }
          },
          "required":["type","title","content"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Download"]
            },
            "url":{
              "type":"string"
            },
            "save":{
              "type":"string"
            },
            "md5":{
              "type":"string",
              "pattern": "[a-f\\d]{32}|[A-F\\d]{32}"
            },
            "overwrite":{
              "type":"boolean"
            },
            "wait":{
              "type":"boolean"
            },
            "thread":{
              "type":"integer",
              "minimum": 1,
              "maximum": 16
            }
          },
          "required":["type"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["Unzip"]
            },
            "source":{
              "type":"string"
            },
            "target":{
              "type":"string"
            },
            "overwrite":{
              "type":"boolean"
            }
          },
          "required":["type","source","target"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["SendKey"]
            },
            "key":{
              "type":"string"
            },
            "focus":{
              "type":"string"
            }
          },
          "required":["type","key","focus"]
        },
        {
          "properties": {
            "type":{
              "type":"string",
              "enum":["SendMouse"]
            },
            "control":{
              "type":"string"
            },
            "focus":{
              "type":"string"
            }
          },
          "required":["type","control","focus"]
        }
      ]
    }
  }
}
